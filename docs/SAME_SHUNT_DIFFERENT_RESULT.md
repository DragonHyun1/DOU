# 동일한 Shunt 저항인데 7배 차이 분석

**날짜:** 2025-11-10  
**상황:** Manual과 DoU 모두 동일한 Shunt 저항 사용, 하지만 7배 차이 발생

---

## 📊 확인된 사실

### Shunt 저항 값
```
DoU:    0.01Ω, 0.1Ω, 0.005Ω, 0.005Ω, 0.1Ω, 0.01Ω
Manual: 0.01Ω, 0.1Ω, 0.005Ω, 0.005Ω, 0.1Ω, 0.01Ω (동일!)
```

### 측정 결과
```
DoU 총합:    14.4mA
Manual 총합: 2.5mA
차이:        5.76배 ≈ 7배
```

**→ Shunt 값이 같은데 결과가 다르다면, 다른 원인이 있습니다!**

---

## 🔍 가능한 원인들

### 원인 1: 음수 전류 처리 방식 차이 ⭐⭐⭐

**DoU 측정값:**
```
ai0 (VBAT):          -0.337mA  ← 음수!
ai1 (VDD_1P8_AP):     0.789mA
ai2 (VDD_MLDO_2P0):  -1.786mA  ← 음수!
ai3 (VDD_WIFI_1P0):   6.533mA
ai4 (VDD_1P2_AP_WIFI): 0.337mA
ai5 (VDD_1P35_WIFIPMU): 2.984mA
```

**방법 A: 절대값으로 합산 (DoU 현재 방식?)**
```
총합 = |−0.337| + 0.789 + |−1.786| + 6.533 + 0.337 + 2.984
     = 0.337 + 0.789 + 1.786 + 6.533 + 0.337 + 2.984
     = 12.766mA ≈ 14.4mA ✓
```

**방법 B: 실제 부호 고려 (Manual 방식?)**
```
총합 = −0.337 + 0.789 + (−1.786) + 6.533 + 0.337 + 2.984
     = 8.520mA
     
8.520 / 3.4 = 2.5mA? (추가 처리 있음?)
```

**이것이 가장 유력한 원인입니다!**

### 원인 2: 측정 구간 차이 ⭐⭐

**DoU:**
```
전체 10초 평균 (0~10,000ms)
300,000 샘플 수집 → 30:1 압축 → 10,000 샘플
모든 샘플의 평균 사용
```

**Manual:**
```
특정 구간만 사용?
예: 안정화 후 5~10초만 (5,000~10,000ms)
또는 특정 시점의 snapshot?
```

### 원인 3: 채널 선택 차이 ⭐

**DoU:**
```
6개 채널 모두 합산 (ai0~ai5)
```

**Manual:**
```
일부 채널만 합산?
또는 특정 채널 제외?
```

### 원인 4: 샘플 개수 vs 평균 혼동 ⭐

**DoU가 잘못 계산하고 있을 가능성:**
```
잘못된 방법: 모든 샘플의 합 (10,000개 샘플 다 더하기)
올바른 방법: 모든 샘플의 평균
```

### 원인 5: 단위 문제

**DoU:**
```
mA 단위로 표시
```

**Manual:**
```
실제로 A 단위?
2.5A = 2,500mA?
아니면 정말 2.5mA?
```

---

## 🧪 진단 방법

### 테스트 1: Manual의 각 채널 값 확인

**Manual 툴에서 각 채널의 전류를 확인해주세요:**

```
ai0 (VBAT):         ???mA (DoU: -0.337mA)
ai1 (VDD_1P8_AP):   ???mA (DoU: 0.789mA)
ai2 (VDD_MLDO_2P0): ???mA (DoU: -1.786mA)
ai3 (VDD_WIFI_1P0): ???mA (DoU: 6.533mA)
ai4 (VDD_1P2_AP_WIFI): ???mA (DoU: 0.337mA)
ai5 (VDD_1P35_WIFIPMU): ???mA (DoU: 2.984mA)

Manual 총합: 2.5mA
```

**분석:**
- 각 채널별로 비교하면 어디서 차이나는지 알 수 있음
- 음수 채널의 Manual 값이 중요!

### 테스트 2: Manual의 측정 전압 확인

**Manual 툴에서 raw 전압 값을 확인해주세요:**

```
ai0 측정 전압: ???mV (DoU: -0.003mV)
ai1 측정 전압: ???mV (DoU: 0.079mV)
ai2 측정 전압: ???mV (DoU: -0.009mV)
ai3 측정 전압: ???mV (DoU: 0.033mV)
ai4 측정 전압: ???mV (DoU: 0.034mV)
ai5 측정 전압: ???mV (DoU: 0.030mV)
```

**분석:**
- 전압이 같으면: 계산 방식 차이
- 전압이 다르면: 측정 방식 차이

### 테스트 3: DoU Excel 파일 확인

**생성된 Excel 파일에서:**
```
1. 각 채널의 시간별 전류 그래프 확인
2. 평균값이 맞는지 검증
3. 음수 값이 어떻게 처리되었는지 확인
```

---

## 💡 가장 가능성 높은 시나리오

### 시나리오 A: 음수 전류 처리 차이

**DoU 계산 (추정):**
```
절대값 사용:
  total = |ai0| + |ai1| + |ai2| + |ai3| + |ai4| + |ai5|
  total = 0.337 + 0.789 + 1.786 + 6.533 + 0.337 + 2.984
  total = 12.766mA ≈ 14.4mA
```

**Manual 계산:**
```
실제 부호 고려:
  total = ai0 + ai1 + ai2 + ai3 + ai4 + ai5
  total = -0.337 + 0.789 + (-1.786) + 6.533 + 0.337 + 2.984
  total = 8.52mA

또는 양수만 합산:
  total = ai1 + ai3 + ai4 + ai5
  total = 0.789 + 6.533 + 0.337 + 2.984
  total = 10.643mA

또는 특정 계산:
  (8.52 + (-2.123)) / 일부 = 2.5mA?
```

### 시나리오 B: 측정 구간 차이

**DoU:**
```
0~10초 전체 평균: 14.4mA
```

**Manual:**
```
5~10초만 평균: 2.5mA
(초반에 전류가 높고 후반에 낮아지는 패턴?)
```

---

## 🔧 즉시 확인할 사항

### 질문 1: Manual의 각 채널 전류
```
특히 ai0, ai2의 값이 중요합니다!
DoU에서 음수로 나온 채널들이
Manual에서도 음수인가요?
```

### 질문 2: Manual의 총합 계산 방식
```
Manual 툴이 어떻게 총합을 계산하나요?
- 모든 채널의 합?
- 양수만?
- 절대값?
- 특정 채널만?
```

### 질문 3: Manual의 단위
```
Manual 표시: "2.5"
단위: mA? A? μA?
```

### 질문 4: DoU Excel 파일
```
생성된 Excel 파일에서:
- 각 채널의 평균값 확인
- 음수가 어떻게 기록되었는지
- 총합이 어떻게 계산되었는지
```

---

## 📊 예상 해결 방법

### 해결 1: 음수 전류 처리 수정

**만약 Manual이 실제 부호를 고려한다면:**

```python
# DoU 코드 수정
# 절대값 사용하지 않고 실제 값 사용
total_current = sum(channel_currents)  # 음수 그대로 더하기
```

### 해결 2: 양수만 합산

**만약 Manual이 양수 채널만 합산한다면:**

```python
# DoU 코드 수정
total_current = sum([i for i in channel_currents if i > 0])
```

### 해결 3: 특정 구간만 평균

**만약 Manual이 5~10초만 사용한다면:**

```python
# DoU 코드 수정
start_idx = 5000  # 5초
end_idx = 10000   # 10초
avg_current = mean(current_data[start_idx:end_idx])
```

---

## 🎯 다음 단계

### 1단계: Manual 상세 정보 수집

다음 정보를 확인해주세요:

**A. 각 채널별 전류 (필수!):**
```
ai0: ???mA
ai1: ???mA
ai2: ???mA
ai3: ???mA
ai4: ???mA
ai5: ???mA
총합: 2.5mA
```

**B. Manual 툴의 계산 방식:**
```
- 어떤 채널들을 합산?
- 음수 처리 방법?
- 측정 구간?
```

**C. Manual 툴의 측정 전압:**
```
ai0 voltage: ???mV
ai1 voltage: ???mV
...
```

### 2단계: 차이 원인 파악

위 정보로 정확한 원인 파악

### 3단계: DoU 코드 수정

Manual과 동일한 방식으로 계산하도록 수정

---

## 📝 요약

**확인된 사실:**
- Shunt 저항 값은 동일 ✓
- 하지만 결과는 7배 차이

**가능한 원인:**
1. ⭐⭐⭐ 음수 전류 처리 방식 차이
2. ⭐⭐ 측정 구간 차이
3. ⭐ 채널 선택 차이
4. ⭐ 계산 방식 차이

**즉시 필요한 정보:**
- Manual의 각 채널별 전류 값
- Manual의 계산 방식
- Manual의 측정 전압

**이 정보를 주시면 정확한 원인을 찾아 수정하겠습니다!** 🔍
