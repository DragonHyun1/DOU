# 7배 전류 차이 분석

**날짜:** 2025-11-10  
**문제:** Manual 2.5mA vs Auto Test 14.4mA (약 7배 차이)

---

## 📊 측정 결과 비교

### Auto Test (DoU) 결과
```
Channel ai0 (VBAT):          -0.337mA
Channel ai1 (VDD_1P8_AP):     0.789mA
Channel ai2 (VDD_MLDO_2P0):  -1.786mA
Channel ai3 (VDD_WIFI_1P0):   6.533mA
Channel ai4 (VDD_1P2_AP_WIFI): 0.337mA
Channel ai5 (VDD_1P35_WIFIPMU): 2.984mA

총합 (절대값): |−0.337| + 0.789 + |−1.786| + 6.533 + 0.337 + 2.984
             = 0.337 + 0.789 + 1.786 + 6.533 + 0.337 + 2.984
             = 12.766mA ≈ 14.4mA (사용자 보고)
```

### Manual 측정 결과
```
총합: 2.5mA
```

### 차이
```
14.4mA ÷ 2.5mA = 5.76배 ≈ 7배
```

---

## 🔍 가능한 원인 분석

### 1. ⭐⭐⭐ 음수 전류 발생 (가장 의심)

**관찰:** 
- ai0 (VBAT): **-0.337mA** (음수!)
- ai2 (VDD_MLDO_2P0): **-1.786mA** (음수!)

**의미:**
Differential 측정에서 음수가 나온다는 것은 **극성이 반대**로 연결되었다는 뜻입니다.

```
올바른 연결:
  Shunt 앞단(+) → ai0+
  Shunt 뒷단(-) → ai8-
  측정값: +6.5mV → +6.5mA

잘못된 연결:
  Shunt 뒷단(-) → ai0+  ← 반대!
  Shunt 앞단(+) → ai8-  ← 반대!
  측정값: -6.5mV → -6.5mA
```

**문제:**
- 음수를 절대값으로 처리하면 **2배 과다 측정**
- 예: 실제 0.5mA인데 -0.5mA로 측정 → |−0.5| = 0.5mA (우연히 맞음)
- 하지만 다른 채널과 합치면 왜곡 발생

### 2. ⭐⭐⭐ Shunt 저항 값 차이

**DoU 설정:**
```
ai0: 0.01Ω
ai1: 0.1Ω
ai2: 0.005Ω
ai3: 0.005Ω
ai4: 0.1Ω
ai5: 0.01Ω
```

**Manual 설정:**
```
ai0: ???Ω ← 확인 필요!
ai1: ???Ω
ai2: ???Ω
ai3: ???Ω
ai4: ???Ω
ai5: ???Ω
```

**영향:**
```
만약 실제 shunt가 0.07Ω인데 DoU가 0.01Ω로 계산하면:
  실제 전류: V / 0.07Ω = 1mA
  DoU 계산: V / 0.01Ω = 7mA
  차이: 7배! ✓
```

**이것이 가장 가능성 높은 원인입니다!**

### 3. ⭐⭐ 측정 구간 차이

**DoU:**
```
전체 10초 평균 (0~10초)
300,000 샘플 → 30:1 압축 → 10,000 샘플 평균
```

**Manual:**
```
특정 구간만 평균?
예: 안정화 후 5~10초만?
또는 특정 순간의 값?
```

**영향:**
```
만약 초반 전류가 낮고 후반이 높다면:
  DoU (전체 평균): 14.4mA
  Manual (초반만): 2.5mA
  차이: 5.76배
```

### 4. ⭐ 계산 방식 차이

**DoU:**
```
각 채널별 계산 → 총합
절대값 사용?
```

**Manual:**
```
실제 방향 고려?
음수는 빼기?
```

---

## 🧪 진단 방법

### 단계 1: 각 채널별로 Manual 값 확인

**DoU vs Manual 채널별 비교:**
```
Channel          DoU      Manual   비율
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ai0 (VBAT)       -0.337   ???     ???
ai1 (VDD_1P8_AP)  0.789   ???     ???
ai2 (VDD_MLDO_2P0) -1.786  ???     ???
ai3 (VDD_WIFI_1P0)  6.533  ???     ???
ai4 (VDD_1P2_AP_WIFI) 0.337 ???     ???
ai5 (VDD_1P35_WIFIPMU) 2.984 ???     ???
```

**확인 사항:**
1. 모든 채널이 7배인가?
2. 특정 채널만 차이가 큰가?
3. 음수 채널의 Manual 값은?

### 단계 2: Shunt 저항 값 확인

**DoU UI에서 설정된 값:**
```
Multi-Channel Monitor → 각 채널 확인
Shunt Resistor (Ω) 컬럼
```

**Manual 툴에서 설정된 값:**
```
Manual 툴 → 설정 화면 → Shunt 값 확인
```

**실제 하드웨어 값:**
```
보드에 표시된 shunt 저항 값 확인
예: "R=0.01Ω", "10mΩ", etc.
```

### 단계 3: 음수 전류 원인 확인

**테스트:**
```
1. ai0 채널만 테스트
2. 연결 바꿔보기 (+/-를 반대로)
3. 음수 → 양수로 변하는지 확인
```

**만약 바뀌면:**
→ 극성 반대로 연결됨 (하드웨어 문제)

**만약 안 바뀌면:**
→ 소프트웨어 계산 문제

---

## 🔧 가능한 해결 방법

### 방법 1: Shunt 저항 값 수정 ⭐⭐⭐

**만약 실제 shunt가 DoU 설정의 7배라면:**

```python
# 현재 설정
ai0: 0.01Ω  → 0.07Ω로 수정
ai1: 0.1Ω   → 0.7Ω로 수정
ai2: 0.005Ω → 0.035Ω로 수정
ai3: 0.005Ω → 0.035Ω로 수정
ai4: 0.1Ω   → 0.7Ω로 수정
ai5: 0.01Ω  → 0.07Ω로 수정
```

**효과:**
```
전류 = V / R
만약 R을 7배로 하면:
  전류 = V / (7R) = (1/7) × 원래 전류
  14.4mA → 2.06mA ✓ (Manual과 비슷!)
```

### 방법 2: 음수 전류 처리

**현재 상황:**
```
ai0: -0.337mA
ai2: -1.786mA
```

**Option A: 절대값 사용 (현재 방식)**
```
총합 = |−0.337| + 0.789 + |−1.786| + ... = 12.766mA
```

**Option B: 실제 방향 고려**
```
총합 = −0.337 + 0.789 + (−1.786) + ... = 8.52mA
```

**Option C: 극성 반전 (하드웨어 수정)**
```
ai0, ai2 채널의 +/-를 바꿔 연결
→ 모두 양수로 측정
```

### 방법 3: 측정 구간 통일

**DoU를 Manual과 동일한 구간으로:**
```python
# 예: 5초~10초만 평균 계산
start_sample = 5000  # 5초 (5000ms)
end_sample = 10000   # 10초
avg = mean(current_data[start_sample:end_sample])
```

---

## 💡 즉시 확인할 사항

### 우선순위 1: Shunt 저항 값 확인 ⭐⭐⭐

**질문:**
1. Manual 툴의 shunt 설정은?
2. 실제 보드의 shunt 값은?
3. DoU 설정과 일치하는가?

**예상:**
```
만약 Manual이 0.07Ω, 0.7Ω, 0.035Ω... 이면:
→ DoU를 동일하게 수정 필요!
```

### 우선순위 2: 각 채널별 비교

**질문:**
Manual의 각 채널 전류는?

```
ai0 (VBAT):         ???mA (DoU: -0.337mA)
ai1 (VDD_1P8_AP):   ???mA (DoU: 0.789mA)
ai2 (VDD_MLDO_2P0): ???mA (DoU: -1.786mA)
ai3 (VDD_WIFI_1P0): ???mA (DoU: 6.533mA)
ai4 (VDD_1P2_AP_WIFI): ???mA (DoU: 0.337mA)
ai5 (VDD_1P35_WIFIPMU): ???mA (DoU: 2.984mA)
```

**분석:**
- 모든 채널이 7배? → Shunt 문제
- 특정 채널만? → 해당 채널 설정 문제
- 음수 채널만? → 극성 문제

### 우선순위 3: 음수 전류 확인

**질문:**
Manual에서 ai0, ai2도 음수인가?

```
Manual ai0: ???mA (양수? 음수?)
Manual ai2: ???mA (양수? 음수?)
```

**분석:**
- Manual도 음수 → 정상 (역전류 흐름)
- Manual은 양수 → DoU 극성 반대

---

## 📊 시나리오별 해결 방법

### 시나리오 A: Shunt 값이 7배 차이

**상황:**
```
DoU:    0.01Ω, 0.1Ω, 0.005Ω...
Manual: 0.07Ω, 0.7Ω, 0.035Ω...
```

**해결:**
```
DoU UI에서 shunt 값 수정 → 재테스트
→ 14.4mA → 2.06mA (Manual과 비슷)
```

### 시나리오 B: 특정 채널만 차이

**상황:**
```
ai3 (VDD_WIFI_1P0): DoU 6.533mA vs Manual 0.9mA (7배)
다른 채널: 비슷함
```

**해결:**
```
ai3의 shunt 값만 수정
→ ai3: 0.005Ω → 0.035Ω
```

### 시나리오 C: 측정 구간 차이

**상황:**
```
DoU (0~10초 평균): 14.4mA
Manual (5~10초 평균): 2.5mA
```

**해결:**
```
DoU 코드 수정:
- 초반 5초 제외
- 5~10초만 평균 계산
```

---

## 🎯 다음 단계

### 1단계: 정보 수집 (즉시)

아래 정보를 확인해주세요:

**A. Manual 툴 설정:**
```
Shunt 저항 (각 채널):
  ai0: ???Ω
  ai1: ???Ω
  ai2: ???Ω
  ai3: ???Ω
  ai4: ???Ω
  ai5: ???Ω
```

**B. Manual 각 채널 전류:**
```
ai0: ???mA
ai1: ???mA
ai2: ???mA
ai3: ???mA
ai4: ???mA
ai5: ???mA
총합: 2.5mA
```

**C. 하드웨어 보드:**
```
실제 shunt 저항 표시: ???Ω
(보드에 인쇄되어 있을 것)
```

### 2단계: 원인 파악

위 정보로 원인 판단:
- Shunt 값 차이 → 수정
- 측정 구간 차이 → 코드 조정
- 극성 문제 → 하드웨어 또는 절대값 처리

### 3단계: 수정 적용

원인에 따라 적절한 수정 적용

---

## 📝 요약

**현재 상황:**
- Manual: 2.5mA
- DoU: 14.4mA (절대값 총합)
- 차이: 약 7배

**가장 가능성 높은 원인:**
1. ⭐⭐⭐ Shunt 저항 값이 7배 차이
2. ⭐⭐ 음수 전류를 절대값으로 처리
3. ⭐ 측정 구간 차이

**즉시 확인 필요:**
1. Manual의 shunt 설정값
2. Manual의 각 채널별 전류
3. 실제 하드웨어 shunt 값

**이 정보를 주시면 정확한 해결책을 제시하겠습니다!**
